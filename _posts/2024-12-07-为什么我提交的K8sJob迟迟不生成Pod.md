---
title: 为什么我提交的K8sJob迟迟不生成Pod
date: 2024-12-07 10:00:00
---

# 前言
在实际使用 Kubernetes 时，一些工程师发现，提交的 Job 在很长一段时间内并未出现在 Pending 状态中等待调度，而是似乎"卡"在了提交与调度的中间环节。这种现象导致用户困惑和不满——他们会问：

"为什么我的 Kubernetes Job 创建后很久都不进入 Pending？"
"Kubernetes Job 提交后要等待数分钟才能排队执行，这是怎么回事？"
"我提交的任务在哪？为什么还不在 Pending 队列里？"
通过这些关键词，当工程师在遇到类似问题进行搜索时，更容易锁定到这篇博客。

## 背景与问题描述
问题表现：

用户提交 Job 后，需要等待数分钟才能在控制台或监控界面看到该 Job 进入 Pending 队列。
在此期间，用户感知上像是任务"丢失"或"挂起"了，集群明明有资源却迟迟不执行任务。
大批量提交任务时，这种延迟显得尤为明显，不仅影响用户体验，也降低了集群整体吞吐效率。
一个典型场景是：用户A一次提交上千个 Job，首个 Job 几乎立即 Pending，但最后一个 Job 却要等待4-6分钟才会进入 Pending，其他用户在此期间提交的新任务也受到影响，产生严重的排队延迟。

## 分析原因：从 Job 到 Pending 状态的漫长等待
在 Kubernetes 中，Job 创建后需由 kube-controller-manager 根据 Job 描述创建相应 Pod，并写入 kube-apiserver。只有在 Pod 对象成功创建并存储后，该 Job 才会显示为 Pending 准备调度。如果这一过程被延迟，用户就会看到 Job 在提交后长时间无法排队的情况。

深入源码和指标分析表明，这种延迟主要受 kube-controller-manager 与 kube-apiserver 通信速率限制 (kube-api-qps 和 kube-api-burst) 所致。默认配置下的 QPS 限制严重降低了高并发提交场景下的 Pod 创建速率，从而引发长时间的排队延迟。

## 优化实践：调高 kube-api-qps 参数
通过实验调整 kube-api-qps 参数，我们发现：

默认 QPS=20 时，每秒仅能处理约8个 Job。
将 QPS 调高至200可处理约26个 Job/秒，实现约3倍性能提升。
虽然进一步提高 QPS（如至400）未持续提升性能，但已确认提升 QPS 在一定区间内能显著减小提交到 Pending 的延迟。

## 总结与展望
通过本次分析与实践，我们明确了 "Kubernetes Job 提交后无法快速进入 Pending 队列" 的根本原因，并提供了可行的优化方案。对于遇到此类问题的工程师而言，适度调高 kube-controller-manager 的 kube-api-qps 与 burst 值，可有效加快 Pod 创建进程，缩短从 Job 提交到显示 Pending 状态的等待时间。

后续工作包括进一步研究在更高 QPS 下的性能瓶颈原因，以及在升级至更高版本的 Kubernetes 后调节 ConcurrentJobSyncs 以获得更大吞吐率提升。希望本文对有类似疑惑的读者有所帮助，也欢迎在评论区分享您的经验与见解。